# π§  _Mshared_ptr β€” C++ μ¤λ§νΈ ν¬μΈν„° μ§μ ‘ κµ¬ν„

> C++ ν‘μ¤€ λΌμ΄λΈλ¬λ¦¬μ `std::shared_ptr`μ™€ μ μ‚¬ν• κΈ°λ¥μ„ μ κ³µν•λ” μ¤λ§νΈ ν¬μΈν„° κµ¬ν„

---

## π“ κ°μ”

C++μ—μ„ λ©”λ¨λ¦¬ κ΄€λ¦¬λ” ν•­μƒ μ¤‘μ”ν• μ£Όμ μ…λ‹λ‹¤.
κ°λ°μκ°€ newλ΅ λ©”λ¨λ¦¬λ¥Ό ν• λ‹Ήν• λ’¤ deleteλ΅ μ§μ ‘ ν•΄μ ν•μ§€ μ•μΌλ©΄, ν”„λ΅κ·Έλ¨μ€ λ©”λ¨λ¦¬ λ„μ(memory leak)λ¥Ό μΌμΌν‚¤κ² λ©λ‹λ‹¤.

νΉν μ—¬λ¬ κ³³μ—μ„ ν•λ‚μ μμ›μ„ κ³µμ ν•λ ¤κ³  ν•  λ• μλ™μΌλ΅ μΉ΄μ΄νΈλ¥Ό κ΄€λ¦¬ν•λ” κ²ƒμ€ μ‹¤μν•κΈ° μ‰½μµλ‹λ‹¤.

μ΄ λ¬Έμ λ¥Ό ν•΄κ²°ν•κΈ° μ„ν• ν•µμ‹¬ κ°λ…μ΄ λ°”λ΅ **μ°Έμ΅° μΉ΄μ΄νΈ(Reference Counting)** μ…λ‹λ‹¤.
_Mshared_ptrμ€ μ΄ κ°λ…μ„ λ°”νƒ•μΌλ΅, λ³µμ ν¬μΈν„°κ°€ ν•λ‚μ κ°μ²΄λ¥Ό κ³µμ ν•κ³  κ΄€λ¦¬ν•λ” κΈ°λ¥μ„ μ κ³µν•©λ‹λ‹¤.

---

## π“ μ°Έμ΅° μΉ΄μ΄ν…μ΄λ€?

> **Reference Counting**
"κ°μ²΄μ— λ€ν• μ°Έμ΅° μλ¥Ό κ΄€λ¦¬ν•μ—¬ λ§μ§€λ§‰ μ°Έμ΅°κ°€ μ‚¬λΌμ§ λ• μλ™μΌλ΅ μμ›μ„ ν•΄μ ν•λ” λ°©λ²•"

### β… ν•΄λ‹Ή μ•„μ΄λ””μ–΄

- **μμ›**(λ©”λ¨λ¦¬, νμΌ λ“±)μ„ μ—¬λ¬ ν¬μΈν„°κ°€ κ³µμ ν•  μ μλ‹¤.
- ν•λ‚μ ν¬μΈν„°κ°€ λ³µμ‚¬λ  λ•λ§λ‹¤ μ°Έμ΅° μλ¥Ό μ¦κ°€μ‹ν‚¨λ‹¤.
- ν¬μΈν„°κ°€ μ†λ©Έλ  λ•λ§λ‹¤ μ°Έμ΅° μλ¥Ό κ°μ†μ‹ν‚¨λ‹¤.
- μ°Έμ΅° μκ°€ 0μ΄ λλ©΄ μμ›μ„ ν•΄μ ν•λ‹¤.

### π“¦ μμ‹

```cpp
{
    _Mshared_ptr<int> p1(new int(42));
    {
        _Mshared_ptr<int> p2 = p1; // μ°Έμ΅° μ μ¦κ°€
    } // p2 μ†λ©Έ β†’ μ°Έμ΅° μ κ°μ†
} // p1 μ†λ©Έ β†’ μ°Έμ΅° μ 0 β†’ delete νΈμ¶
```
μ΄μ²λΌ Reference Countingμ„ ν™μ©ν•λ©΄ λ©”λ¨λ¦¬ κ΄€λ¦¬λ¥Ό μ•μ „ν•κ³  μμΈ΅ κ°€λ¥ν•κ² ν•  μ μμµλ‹λ‹¤.

## β“ μ™ μ§μ ‘ shared_ptrμ„ κµ¬ν„ν–μ„κΉ?

- μ¤λ§νΈ ν¬μΈν„°μ **ν•µμ‹¬ μ›λ¦¬μΈ μ°Έμ΅° μ κ΄€λ¦¬**, **κ³µμ λ μ†μ κ¶**, **μλ™ λ©”λ¨λ¦¬ ν•΄μ **λ¥Ό μ§μ ‘ κµ¬ν„ν•λ©° μ •ν™•ν μ΄ν•΄ν•  μ μμµλ‹λ‹¤.
- `std::shared_ptr`λ” λ„λ¬΄ νΈλ¦¬ν•μ§€λ§, λ‚΄λ¶€ λ™μ‘μ„ μ •ν™•ν μ΄ν•΄ν•λ©΄ ν¬μΈν„° μ•μ „μ„±μ΄λ‚ λ©”λ¨λ¦¬ μµμ ν™” μΈ΅λ©΄μ—μ„ λ” κΉμ€ κ°μ„ μ–»μ„ μ μμµλ‹λ‹¤.



## β™οΈ κµ¬ν„ν• κΈ°λ¥λ“¤

| κΈ°λ¥                     | μ„¤λ… |
|--------------------------|------|
| μ°Έμ΅° μ κΈ°λ° μμ› ν•΄μ     | λ§μ§€λ§‰ ν¬μΈν„° μ†λ©Έ μ‹ μλ™μΌλ΅ delete νΈμ¶ |
| λ³µμ‚¬ μ§€μ›                | λ³µμ‚¬ μƒμ„±μ/ν• λ‹Ήμλ΅ μ°Έμ΅° μ μ¦κ°€ |
| μ΄λ™ μ§€μ›                | μ΄λ™ μƒμ„±μ/μ΄λ™ ν• λ‹Ήμλ΅ μ†μ κ¶ μ΄λ™ κ°€λ¥ |
| `get()`                  | λ‚΄λ¶€ ν¬μΈν„°λ¥Ό λ°ν™ |
| `use_count()`             | ν„μ¬ μ°Έμ΅° μλ¥Ό λ°ν™ |
| `unique()`               | μ°Έμ΅° μκ°€ 1μΈμ§€ ν™•μΈ |
| `operator*`, `operator->` | ν¬μΈν„°μ²λΌ κ°μ²΄μ— μ ‘κ·Ό κ°€λ¥ |

---

## π μ‚¬μ© μμ‹

```cpp
#include "_Mshared_ptr.hpp"
#include <iostream>

class Test {
public:
    Test() { std::cout << "Test κ°μ²΄ μƒμ„±\n"; }
    ~Test() { std::cout << "Test κ°μ²΄ μ†λ©Έ\n"; }

    void hello() const {
        std::cout << "Hello from Test\n";
    }
};

int main() {
    {
        _Mshared_ptr<Test> sp1(new Test());
        std::cout << "sp1 use_count: " << sp1.use_count() << "\n";

        {
            _Mshared_ptr<Test> sp2 = sp1;
            std::cout << "sp2 use_count: " << sp2.use_count() << "\n";

            sp2->hello();
        } // sp2 μ†λ©Έ β†’ μ°Έμ΅° μ κ°μ†

        std::cout << "sp1 use_count after sp2 destroyed: " << sp1.use_count() << "\n";
    } // sp1 μ†λ©Έ β†’ μ°Έμ΅° μ 0 β†’ κ°μ²΄ μ†λ©Έ
}
```
# κ²°κ³Ό μμ‹
```
Test κ°μ²΄ μƒμ„±
sp1 use_count: 1
sp2 use_count: 2
Hello from Test
sp1 use_count after sp2 destroyed: 1
Test κ°μ²΄ μ†λ©Έ
```

## π› οΈ μ‚¬μ© ν™κ²½

C++17 μ΄μƒ

clang++, g++, MSVC λ“± λ€λ¶€λ¶„μ μ»΄νμΌλ¬μ—μ„ λ™μ‘ κ°€λ¥

ν…ν”λ¦Ώ ν΄λμ¤μ΄λ―€λ΅ ν—¤λ”νμΌμ—μ„ μ •μ ν¬ν•¨
___

## π§° μ–΄λ κ³³μ— μ“°μ—¬μ§€λ”κ°€?
- μ—¬λ¬ κ³³μ—μ„ ν•λ‚μ κ°μ²΄λ¥Ό μ•μ „ν•κ² κ³µμ ν•  λ•
- λ³µμ΅ν• μ†μ κ¶ κ΄€κ³„λ¥Ό λ…μ‹μ μΌλ΅ κ΄€λ¦¬ν•κΈ° μ–΄λ ¤μ΄ μ½”λ“
- μμ™Έ λ°μƒ κ°€λ¥μ„±μ΄ λ†’μ€ μ½”λ“μ—μ„ λ©”λ¨λ¦¬ λ„μ λ°©μ§€
- λ¦¬μ†μ¤ μλ… κ΄€λ¦¬λ¥Ό λ…ν™•ν ν•κ³  μ‹¶μ„ λ•

## π“ μ°Έκ³  μλ£

- [cppreference - std::shared_ptr](https://en.cppreference.com/w/cpp/memory/shared_ptr)
- [Scott Meyers - Effective Modern C++](https://www.oreilly.com/library/view/effective-modern-c/9781491908419/)
- [Herb Sutter - Resource Management Techniques](https://herbsutter.com/)

---

## π”– λ§μΉλ©°

μ¤λ§νΈ ν¬μΈν„°λ¥Ό μ§μ ‘ κµ¬ν„ν•λ©΄μ„ μ°Έμ΅° μ κ΄€λ¦¬μ™€ μμ› ν•΄μ  ν¨ν„΄μ„ κΉμ΄ μ΄ν•΄ν•  μ μμ—μµλ‹λ‹¤.
μ΄ ν”„λ΅μ νΈλ” μ†μ κ¶ κ΄€λ¦¬, λ©”λ¨λ¦¬ μ•μ „μ„±, μ΄λ™ μ‹λ©ν‹± λ“± ν„λ€ C++μ ν•µμ‹¬ κ°λ…μ„ ν†µν•©μ μΌλ΅ μ—°μµν•κΈ° μ„ν• ν›λ¥­ν• κΈ°λ°μ΄ λμ—μµλ‹λ‹¤.
